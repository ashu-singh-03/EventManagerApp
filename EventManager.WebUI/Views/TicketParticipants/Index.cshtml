@model int
@{
    Layout = "/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Manage Ticket Participants";
}

<div class="container-fluid py-4">
    <div class="container-fluid py-4">
        <!-- Elegant Back Button in Card Header -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-3">
                <div class="d-flex align-items-center">
                    <a href="/TicketAccessPoint/Index"
                       class="btn btn-outline-warning d-flex align-items-center me-3">
                        <i class="fas fa-arrow-left me-2"></i>
                        Back
                    </a>
                    <div class="vr me-3"></div>
                    <div>
                        <h5 class="mb-0 text-dark">
                            <i class="fas fa-users text-warning me-2"></i>
                            Participants Management
                        </h5>
                        <small class="text-muted">Manage participant assignments for this event</small>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Back Button -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100 bg-white">
                <div class="card-body p-3 d-flex align-items-center">
                    <div class="text-center me-3">
                        <i class="fas fa-users fa-2x text-warning"></i> <!-- Changed from text-primary to text-warning -->
                    </div>
                    <div>
                        <p class="text-muted small fw-bold mb-0">Total Participants</p>
                        <h4 class="fw-bold text-dark mb-0" id="totalCount">0</h4>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100 bg-white">
                <div class="card-body p-3 d-flex align-items-center">
                    <div class="text-center me-3">
                        <i class="fas fa-user-check fa-2x text-success"></i>
                    </div>
                    <div>
                        <p class="text-muted small fw-bold mb-0">Assigned Participants</p>
                        <h4 class="fw-bold text-success mb-0" id="assignedCount">0</h4>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100 bg-white">
                <div class="card-body p-3 d-flex align-items-center">
                    <div class="text-center me-3">
                        <i class="fas fa-user-slash fa-2x text-secondary"></i>
                    </div>
                    <div>
                        <p class="text-muted small fw-bold mb-0">Unassigned Participants</p>
                        <h4 class="fw-bold text-secondary mb-0" id="unassignedCount">0</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-lg">
        <div class="card-header bg-white border-bottom py-3">
            <div class="row align-items-center">
                <div class="col-lg-6 mb-2 mb-lg-0">
                    <h5 class="mb-0 text-dark">
                        <i class="fas fa-users text-warning me-2"></i> <!-- Changed from text-primary to text-warning -->
                        Participants List
                    </h5>
                </div>
                <div class="col-lg-6">
                    <div class="d-flex flex-wrap justify-content-lg-end gap-2">
                        <button type="button" class="btn btn-outline-warning btn-sm" id="selectAllBtn">
                            <!-- Changed from btn-outline-primary to btn-outline-warning -->
                            <i class="fas fa-check-double me-1"></i>Select All Visible
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="clearAllBtn">
                            <i class="fas fa-times me-1"></i>Clear All Visible
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-body p-0">
            <div id="messageContainer" class="m-3" style="display: none;"></div>

            <div id="loading" class="text-center py-5">
                <div class="spinner-border text-warning" role="status">
                    <!-- Changed from text-primary to text-warning -->
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted mt-2">Loading participants...</p>
            </div>

            <form id="assignmentForm" method="post" action="/TicketParticipants/Save" style="display: none;">
                <input type="hidden" name="TicketTypeId" value="@Model" />

                <div class="table-responsive p-3">
                    <table class="table table-hover table-striped mb-0" id="participantsTable" style="width:100%">
                        <thead class="table-light">
                            <tr>
                                <th width="5%" class="text-center">
                                    <!-- Checkbox -->
                                </th>
                                <th width="25%">Name</th>
                                <th width="25%">Email</th>
                                <th width="25%">Phone</th>
                                <th width="10%">Company</th>
                                <th width="10%">Status</th>
                            </tr>
                        </thead>
                        <tbody id="participantsBody">
                            <!-- Participants will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <div id="emptyState" class="text-center py-5" style="display: none;">
                    <i class="fas fa-user-slash fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">No Participants Found</h5>
                    <p class="text-muted">There are no participants available for this event.</p>
                </div>

                <div class="p-3 border-top bg-white sticky-bottom shadow-sm">
                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-warning px-4">
                            <!-- Changed from btn-primary to btn-warning -->
                            <i class="fas fa-save me-2"></i>Save Changes
                        </button>
                        <a href="/TicketParticipants" class="btn btn-outline-secondary ms-2">
                            Cancel
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
</div>
@section Scripts {
    <script>
        $(document).ready(function() {
            const ticketTypeId = @Model;
            let allParticipants = [];
            let dataTableInstance;

            // --- Utility Functions ---
            function getParticipantIcon(name) {
                const nameLower = name.toLowerCase();
                if (nameLower.includes('vip') || nameLower.includes('special')) return 'fa-crown';
                if (nameLower.includes('speaker') || nameLower.includes('presenter')) return 'fa-microphone';
                if (nameLower.includes('staff') || nameLower.includes('organizer')) return 'fa-user-tie';
                return 'fa-user';
            }

            // --- SHOW ALERT FUNCTION (Same as Access Points) ---
            function showAlert(type, message) {
                let alertClass, iconClass, title;

                if (type === 'success') {
                    alertClass = 'alert-warning border-start border-4 border-success';
                    iconClass = 'fas fa-check-circle text-success me-2';
                    title = 'Success!';
                } else if (type === 'warning') {
                    alertClass = 'alert-warning border-start border-4 border-warning';
                    iconClass = 'fas fa-exclamation-triangle text-warning me-2';
                    title = 'Attention:';
                } else if (type === 'danger') {
                    alertClass = 'alert-danger border-start border-4 border-danger';
                    iconClass = 'fas fa-times-circle text-danger me-2';
                    title = 'Error:';
                } else {
                    alertClass = 'alert-info border-start border-4 border-info';
                    iconClass = 'fas fa-info-circle text-info me-2';
                    title = 'Info:';
                }

                const html = `
                    <div class="alert ${alertClass} alert-dismissible fade show d-flex align-items-center" role="alert">
                        <i class="${iconClass} fs-5"></i>
                        <div>
                            <strong class="me-1">${title}</strong> ${message}
                        </div>
                        <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
                    </div>
                `;

                $('#messageContainer').html(html).show();
                // Auto-close success/info alerts
                if (type === 'success' || type === 'info') {
                    setTimeout(() => { $('.alert').alert('close'); }, 5000);
                }
            }
            // --- END SHOW ALERT ---

            function updateStats() {
                const total = allParticipants.length;
                const assigned = allParticipants.filter(p => p.isChecked).length;
                const unassigned = total - assigned;

                $('#totalCount').text(total);
                $('#assignedCount').text(assigned);
                $('#unassignedCount').text(unassigned);
            }

            function initializeDataTables(data) {
                if (dataTableInstance) {
                    dataTableInstance.destroy();
                    $('#participantsBody').empty();
                }

                const tableData = data.map(p => [
                    p.participantId,
                    p.fullName,
                    p.email,
                    p.phone,
                    p.company,
                    p.isChecked
                ]);

                dataTableInstance = $('#participantsTable').DataTable({
                    data: tableData,
                    columns: [
                        {
                            data: 0, // Checkbox column
                            render: function(data, type, row) {
                                const isChecked = row[5];
                                return `
                                    <div class="form-check text-center">
                                        <input class="form-check-input participant-checkbox"
                                            type="checkbox"
                                            value="${data}"
                                            ${isChecked ? 'checked' : ''}
                                            data-name="${row[1]}"
                                            style="margin: 0 auto;">
                                    </div>
                                `;
                            },
                            orderable: false,
                            className: 'ps-3'
                        },
                        {
                            data: 1, // Name column
                            render: function(data, type, row) {
                                const icon = getParticipantIcon(data);
                                return `
                                    <div class="d-flex align-items-center">
                                        <i class="fas ${icon} fa-fw fs-5 text-warning me-3"></i> <!-- Changed to text-warning -->
                                        <div class="fw-medium">${data}</div>
                                    </div>
                                `;
                            }
                        },
                        {
                            data: 2, // Email column
                            render: function(data) {
                                if (data) {
                                    return `<a href="mailto:${data}" class="text-decoration-none">${data}</a>`;
                                }
                                return '<span class="text-muted">N/A</span>';
                            }
                        },
                        {
                            data: 3, // Phone column
                            render: function(data) {
                                if (data) {
                                    return `<a href="tel:${data}" class="text-decoration-none">${data}</a>`;
                                }
                                return '<span class="text-muted">N/A</span>';
                            }
                        },
                        {
                            data: 4, // Company column
                            render: function(data) {
                                return data || '<span class="text-muted">N/A</span>';
                            }
                        },
                        {
                            data: 5, // Status column
                            render: function(data) {
                                const statusText = data ? 'Assigned' : 'Unassigned';
                                const statusClass = data ? 'bg-success' : 'bg-secondary';
                                return `<span class="badge ${statusClass}">${statusText}</span>`;
                            }
                        }
                    ],
                    lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
                    pageLength: 25,
                    dom: 'lfrtip',
                    responsive: true
                });

                // Event delegation for checkbox changes
                $('#participantsBody').off('change', '.participant-checkbox').on('change', '.participant-checkbox', function() {
                    updateGlobalState($(this).val(), $(this).is(':checked'));
                    updateStats();
                });
            }

            function updateGlobalState(id, isChecked) {
                const participant = allParticipants.find(item => item.participantId.toString() === id.toString());
                if (participant) {
                    participant.isChecked = isChecked;
                }

                if (dataTableInstance) {
                    dataTableInstance.rows().every(function() {
                        const rowData = this.data();
                        if (rowData[0].toString() === id.toString()) {
                            rowData[5] = isChecked;
                            this.data(rowData);
                            this.invalidate();
                        }
                    });
                    dataTableInstance.draw(false);
                }
            }

            function loadParticipants() {
                $('#loading').show();
                $('#assignmentForm').hide();
                $('#emptyState').hide();

                $.ajax({
                    url: '/TicketParticipants/LoadParticipants?ticketTypeId=' + ticketTypeId,
                    type: 'GET',
                    success: function(response) {
                        $('#loading').hide();
                        allParticipants = response || [];

                        if (allParticipants.length > 0) {
                            // Process participants to match expected format
                            allParticipants = allParticipants.map(p => {
                                const processed = {
                                    participantId: p.participantId || p.ParticipantId || 0,
                                    fullName: (p.firstName || p.FirstName || '') + ' ' + (p.lastName || p.LastName || ''),
                                    email: p.email || p.Email || '',
                                    phone: p.phone || p.Phone || '',
                                    company: p.company || p.Company || '',
                                    department: p.department || p.Department || '',
                                    isChecked: p.isAssigned || p.IsAssigned || false
                                };
                                // Trim fullName
                                processed.fullName = processed.fullName.trim();
                                return processed;
                            });

                            initializeDataTables(allParticipants);
                            $('#assignmentForm').show();
                        } else {
                            $('#emptyState').show();
                        }
                        updateStats();
                    },
                    error: function(xhr, status, error) {
                        $('#loading').hide();
                        showAlert('danger', 'Error loading participants. Please try again.');
                        console.error('Error:', error);
                    }
                });
            }

            // --- Event Handlers ---
            loadParticipants();

            // Select All Visible
            $('#selectAllBtn').on('click', function() {
                if (dataTableInstance) {
                    dataTableInstance.rows({ search: 'applied', page: 'current' }).nodes().to$().find('.participant-checkbox').each(function() {
                        const id = $(this).val();
                        $(this).prop('checked', true);
                        updateGlobalState(id, true);
                    });
                    updateStats();
                }
            });

            // Clear All Visible
            $('#clearAllBtn').on('click', function() {
                if (dataTableInstance) {
                    dataTableInstance.rows({ search: 'applied', page: 'current' }).nodes().to$().find('.participant-checkbox').each(function() {
                        const id = $(this).val();
                        $(this).prop('checked', false);
                        updateGlobalState(id, false);
                    });
                    updateStats();
                }
            });

            // Form Submission
            $('#assignmentForm').on('submit', function(e) {
                e.preventDefault();

                const form = $(this);
                const submitBtn = form.find('button[type="submit"]');

                const checkedParticipants = allParticipants.filter(p => p.isChecked);
                const selectedCount = checkedParticipants.length;
                const checkedIds = checkedParticipants.map(p => p.participantId);

                // Confirmation for clearing all
                if (selectedCount === 0 && !confirm('No participants selected. This will remove all assignments. Continue?')) {
                    return;
                }

                const postData = {
                    TicketTypeId: ticketTypeId,
                    ParticipantIds: checkedIds
                };

                submitBtn.prop('disabled', true);
                submitBtn.html('<span class="spinner-border spinner-border-sm me-2"></span>Saving...');

                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: postData,
                    success: function(response) {
                        if (response && response.success) {
                            let alertMessage;

                            if (selectedCount === 0) {
                                alertMessage = 'Successfully cleared all participant assignments.';
                                showAlert('warning', alertMessage);
                            } else {
                                alertMessage = `Successfully saved ${selectedCount} participant(s) assigned to this ticket type.`;
                                showAlert('success', alertMessage);
                            }
                            loadParticipants();
                        } else {
                            showAlert('danger', 'Save failed: Server returned an error.');
                        }
                    },
                    error: function(xhr, status, error) {
                        let errorMessage = 'Error saving assignments. Please try again.';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = 'Error saving assignments: ' + xhr.responseJSON.message;
                        }
                        showAlert('danger', errorMessage);
                    },
                    complete: function() {
                        setTimeout(() => {
                            submitBtn.prop('disabled', false);
                            submitBtn.html('<i class="fas fa-save me-2"></i>Save Changes');
                        }, 1000);
                    }
                });
            });
        });
    </script>
}