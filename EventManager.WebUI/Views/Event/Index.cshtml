@model IEnumerable<EventManager.Application.DTOs.EventDto>

@{
    Layout = "/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Event Hub - Elite View";
}

<style>
    /* TOAST NOTIFICATION AREA */
    .alert-area {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        width: 350px;
    }

    .alert {
        display: flex;
        align-items: flex-start;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        animation: slideIn 0.3s ease-out;
        background: white;
        border: 1px solid #eee;
    }

    @@keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* PAGE LAYOUT - Reduced "White" feel with a subtle mesh background */
    .event-hub-bg {
        background-color: #f8fafc;
        background-image: radial-gradient(at 0% 0%, rgba(255, 193, 7, 0.05) 0px, transparent 50%), radial-gradient(at 100% 0%, rgba(15, 23, 42, 0.05) 0px, transparent 50%);
        min-height: 100vh;
        padding: 60px 0;
    }

    /* MASTER CARD - Added glassmorphism effect to create depth */
    .master-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(226, 232, 240, 0.8);
        border-radius: 40px;
        box-shadow: 0 20px 60px -10px rgba(0,0,0,0.05);
        padding: 40px;
        margin: 0 40px;
    }

    /* CARD DESIGN IMPROVEMENTS */
    .event-card {
        border: 1px solid #edf2f7;
        border-radius: 30px;
        background: #fff;
        height: 100%;
        display: flex;
        flex-direction: column;
        min-height: 440px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

        .event-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.08);
            border-color: #FFC107;
        }

    .event-title {
        font-size: 1.35rem;
        font-weight: 800;
        color: #1e293b;
        margin: 20px 0;
        line-height: 1.3;
        flex-grow: 1;
    }

    /* INFO BOX - Darkened slightly for better visual anchor */
    .info-container {
        background: #f1f5f9;
        border-radius: 20px;
        padding: 18px;
        margin-bottom: 20px;
        border: 1px solid #e2e8f0;
        display: flex;
    }

    .date-box {
        text-align: center;
        border-radius: 12px;
        overflow: hidden;
        width: 60px;
        border: 1px solid #e2e8f0;
        background: white;
    }

    .date-box-month {
        background: #0f172a;
        color: #fff;
        font-size: 0.65rem;
        font-weight: 800;
        padding: 4px;
    }

    .date-box-day {
        font-size: 1.25rem;
        font-weight: 900;
        color: #0f172a;
        padding: 6px;
    }

    .participant-pill {
        background: #fffbeb;
        color: #b45309;
        padding: 6px 14px;
        border-radius: 50px;
        font-weight: 800;
        font-size: 0.8rem;
        border: 1px solid #fef3c7;
    }

    .info-label {
        font-size: 0.65rem;
        text-transform: uppercase;
        color: #64748b;
        font-weight: 800;
        display: block;
        margin-bottom: 2px;
    }

    .info-value {
        font-weight: 700;
        color: #334155;
        font-size: 0.9rem;
    }

    .btn-action {
        border-radius: 15px;
        font-weight: 800;
        padding: 14px;
        border: none;
        transition: 0.2s;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-manage {
        background: #0f172a;
        color: #fff;
    }

        .btn-manage:hover {
            background: #1e293b;
            color: white;
        }

    .btn-edit-lite {
        background: #f8fafc;
        color: #475569;
        border: 1px solid #e2e8f0;
    }

    .btn-delete-lite {
        background: #fff1f2;
        color: #e11d48;
        border: 1px solid #ffe4e6;
    }

    /* SEARCH BAR UI */
    .dataTables_filter {
        float: left !important;
        margin-bottom: 30px;
    }

        .dataTables_filter input {
            border-radius: 20px !important;
            padding: 14px 25px !important;
            width: 400px !important;
            border: 2px solid #e2e8f0 !important;
            background: #ffffff !important;
            transition: border-color 0.3s;
        }

            .dataTables_filter input:focus {
                border-color: #FFC107 !important;
                outline: none;
            }
</style>

@Html.AntiForgeryToken()

<div class="alert-area"></div>

<div class="event-hub-bg">
    <div class="container-fluid px-5 mb-5">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-5 fw-bold text-dark mb-0">Event Hub Dashboard</h1>
            </div>
            <div class="col-md-4 text-md-end">
                <a class="btn btn-warning px-5 py-3 fw-bold shadow-sm" style="border-radius:18px; background:#FFC107; border:none;" asp-action="Create">
                    <i class="fa-solid fa-plus-circle me-2"></i> NEW EVENT
                </a>
            </div>
        </div>
    </div>

    <div class="master-card">
        <table id="eventTable" style="display:none;">
            <thead><tr><th>Data</th></tr></thead>
            <tbody>
                @foreach (var evt in Model)
                {
                    <tr id="row_@evt.EventId">
                        <td>
                            <div class="card event-card p-4">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="date-box shadow-sm">
                                        <div class="date-box-month">@DateTime.Parse(evt.EventDate).ToString("MMM").ToUpper()</div>
                                        <div class="date-box-day">@DateTime.Parse(evt.EventDate).ToString("dd")</div>
                                    </div>
                                    <span class="participant-pill">
                                        <i class="fa-solid fa-users me-1"></i> @evt.ParticipantCount
                                    </span>
                                </div>

                                <h5 class="event-title">@evt.EventName</h5>

                                <div class="info-container">
                                    <div class="flex-grow-1">
                                        <span class="info-label">Timing</span>
                                        <span class="info-value">
                                            <i class="fa-regular fa-clock text-warning me-1"></i>
                                            @{
                                                TimeSpan ts;
                                                string time = TimeSpan.TryParse(evt.EventTime, out ts)
                                                ? DateTime.Today.Add(ts).ToString("h:mm tt") : "TBD";
                                            }
                                            @time
                                        </span>
                                    </div>
                                    <div class="flex-grow-1 border-start ps-3 ms-2">
                                        <span class="info-label">Venue</span>
                                        <span class="info-value text-truncate d-block" style="max-width: 120px;">
                                            <i class="fa-solid fa-location-dot text-warning me-1"></i> @evt.Location
                                        </span>
                                    </div>
                                </div>

                                <div class="actions mt-auto">
                                    <form method="post" asp-action="SetEventAndManage" class="mb-2">
                                        <input type="hidden" name="eventId" value="@evt.EventId" />
                                        <button type="submit" class="btn btn-action btn-manage w-100">MANAGE EVENT</button>
                                    </form>
                                    <div class="d-flex gap-2">
                                        <a asp-action="Edit" asp-route-id="@evt.EventId" class="btn btn-action btn-edit-lite flex-grow-1 d-flex align-items-center justify-content-center">
                                            <i class="fa-solid fa-pen"></i>
                                        </a>
                                        <button class="btn btn-action btn-delete-lite flex-grow-1 delete-event" data-id="@evt.EventId">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div id="cardContainer" class="row g-4"></div>
    </div>
</div>

@section Scripts {

    <script>
        function showToast(message, type = 'success') {
            const alertId = 'alert-' + Date.now();
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
            const toastHtml = `
                <div id="${alertId}" class="alert border">
                    <i class="fas ${icon} me-3 text-${type === 'success' ? 'success' : 'danger'}" style="font-size:1.5rem"></i>
                    <div class="flex-grow-1">
                        <div class="fw-bold">${type === 'success' ? 'Success' : 'Error'}</div>
                        <div class="small text-muted">${message}</div>
                    </div>
                </div>`;
            $('.alert-area').append(toastHtml);
            setTimeout(() => { $(`#${alertId}`).fadeOut(300, function() { $(this).remove(); }); }, 4000);
        }

        $(document).ready(function () {
            var table = $('#eventTable').DataTable({
                "dom": '<"row"<"col-12"f>>rt<"row"<"col-12"p>>',
                "pageLength": 8,
                "language": { "search": "", "searchPlaceholder": "Filter events..." },
                "drawCallback": function () {
                    var container = $('#cardContainer').empty();
                    var rows = this.api().rows({ page: 'current' }).data();

                    if(rows.length === 0) {
                        container.append('<div class="col-12 text-center py-5"><h3 class="text-muted">No events found</h3></div>');
                    } else {
                        rows.each(function (data) {
                            container.append($('<div class="col-12 col-md-6 col-lg-4 col-xl-3"></div>').append(data[0]));
                        });
                    }
                }
            });

            $(document).on('click', '.delete-event', function () {
                var btn = $(this);
                var id = btn.data('id');

                if (confirm('Are you sure you want to delete this event?')) {
                    btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

                    $.ajax({
                        url: '@Url.Action("Delete", "Event")',
                        type: 'POST',
                        headers: { "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val() },
                        data: { id: id },
                        success: function (res) {
                            if (res.success) {
                                table.row('#row_' + id).remove().draw(false);
                                showToast(res.message, 'success');
                            } else {
                                showToast(res.message, 'danger');
                                btn.prop('disabled', false).html('<i class="fa-solid fa-trash"></i>');
                            }
                        },
                        error: function () {
                            showToast('Server error.', 'danger');
                            btn.prop('disabled', false).html('<i class="fa-solid fa-trash"></i>');
                        }
                    });
                }
            });
        });
    </script>
}