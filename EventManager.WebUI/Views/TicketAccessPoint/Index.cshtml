@{
    Layout = "/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Ticket Types Management";
}

<style>
    .ticket-type-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid #e9ecef;
    }

        .ticket-type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border-color: #ffc107;
        }

    .manage-btn:hover {
        background-color: #ffc107 !important;
        border-color: #ffc107 !important;
        color: #212529 !important;
    }
</style>

<div class="container">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center gap-3 mb-2">
                <i class="fas fa-ticket-alt fa-2x text-warning"></i>
                <h1 class="h3 mb-0 fw-bold">Ticket Types Management</h1>
            </div>
            <p class="text-muted">Manage your ticket types and their access permissions</p>
        </div>
    </div>

    <!-- Ticket Types Section -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h5 class="mb-0">
                                <i class="fas fa-list text-warning me-2"></i>
                                Ticket Types
                            </h5>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-warning" id="refreshBtn">
                                <i class="fas fa-sync-alt me-1"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    <!-- Loading -->
                    <div id="loadingTicketTypes" class="text-center py-5">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2">Loading ticket types...</p>
                    </div>

                    <!-- Ticket Types Grid -->
                    <div id="ticketTypesContainer" class="row g-3" style="display: none;">
                        <!-- Dynamic content from YOUR API -->
                    </div>

                    <!-- Empty State -->
                    <div id="emptyTicketTypes" class="text-center py-5" style="display: none;">
                        <i class="fas fa-ticket-alt fa-4x text-muted opacity-25 mb-3"></i>
                        <h5 class="text-muted">No Ticket Types Found</h5>
                        <p class="text-muted mb-3">There are no ticket types available for this event</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-warning text-dark">
            <strong class="me-auto">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Toast function
            function showToast(message, type = 'info') {
                const toastElement = document.getElementById('liveToast');
                const toastBody = document.getElementById('toastMessage');

                // Set toast color
                const toastHeader = toastElement.querySelector('.toast-header');
                toastHeader.className = 'toast-header ';

                switch(type) {
                    case 'success':
                        toastHeader.classList.add('bg-success', 'text-white');
                        break;
                    case 'error':
                        toastHeader.classList.add('bg-danger', 'text-white');
                        break;
                    case 'warning':
                        toastHeader.classList.add('bg-warning', 'text-dark');
                        break;
                    default:
                        toastHeader.classList.add('bg-info', 'text-white');
                }

                toastBody.textContent = message;
                const toast = new bootstrap.Toast(toastElement);
                toast.show();
            }

            // Load ticket types from YOUR API endpoint
            function loadTicketTypes() {
                $.ajax({
                    url: '/TicketAccessPoint/GetTicketTypes',  // ✅ YOUR endpoint
                    type: 'GET',
                    beforeSend: function() {
                        $('#loadingTicketTypes').show();
                        $('#ticketTypesContainer').hide();
                        $('#emptyTicketTypes').hide();
                    },
                    success: function(data) {
                        if (data && data.length > 0) {
                            renderTicketTypes(data);
                            $('#ticketTypesContainer').show();
                        } else {
                            $('#emptyTicketTypes').show();
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading ticket types:', error);
                        showToast('Failed to load ticket types. Please try again.', 'error');
                        $('#emptyTicketTypes').show();
                    },
                    complete: function() {
                        $('#loadingTicketTypes').hide();
                    }
                });
            }

            // Render ticket types from YOUR database
            function renderTicketTypes(ticketTypes) {
                const container = $('#ticketTypesContainer');
                container.empty();

                ticketTypes.forEach(function(ticket) {
                    // Use YOUR DTO properties (ticketTypeId, ticketName, price, description)
                    const card = `
                        <div class="col-md-6 col-lg-4 col-xl-3">
                            <div class="card ticket-type-card h-100 border">
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <span class="badge ${ticket.price === 0 ? 'bg-success' : 'bg-warning'} bg-opacity-10 ${ticket.price === 0 ? 'text-success' : 'text-warning'} mb-2">
                                                ${ticket.price === 0 ? 'FREE' : '$' + ticket.price}
                                            </span>
                                            <h6 class="card-title mb-1 mt-2 fw-bold">${ticket.ticketName}</h6>
                                            ${ticket.maxCapacity ?
                                                `<p class="text-muted small mb-0">
                                                    <i class="fas fa-users me-1"></i>Capacity: ${ticket.maxCapacity}
                                                </p>` : ''
                                            }
                                        </div>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary border-0" type="button"
                                                    data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li>
                                                    <a class="dropdown-item" href="/TicketAccessPoint/Manage/${ticket.ticketTypeId}">
                                                        <i class="fas fa-door-open me-2"></i>Manage Access
                                                    </a>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <a class="dropdown-item text-warning" href="#">
                                                        <i class="fas fa-edit me-2"></i>Edit
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item text-danger" href="#" onclick="deleteTicketType(${ticket.ticketTypeId})">
                                                        <i class="fas fa-trash me-2"></i>Delete
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <p class="card-text small text-muted mb-3 flex-grow-1">
                                        ${ticket.description || 'No description available'}
                                    </p>
                                    <a href="/TicketAccessPoint/Manage/${ticket.ticketTypeId}"
                                       class="btn btn-outline-warning w-100 manage-btn">
                                        <i class="fas fa-cog me-2"></i>Manage Access Points
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                    container.append(card);
                });
            }

            // Delete ticket type - Update to use YOUR endpoint
            window.deleteTicketType = function(id) {
                if (confirm('Are you sure you want to delete this ticket type?')) {
                    $.ajax({
                        url: `/TicketAccessPoint/DeleteTicketType?id=${id}`,  // You need to create this endpoint
                        type: 'DELETE',
                        success: function() {
                            showToast('Ticket type deleted successfully', 'success');
                            loadTicketTypes(); // Reload the list
                        },
                        error: function() {
                            showToast('Failed to delete ticket type', 'error');
                        }
                    });
                }
            };

            // Refresh button
            $('#refreshBtn').click(function() {
                const icon = $(this).find('i');
                icon.addClass('fa-spin');
                loadTicketTypes();
                setTimeout(() => {
                    icon.removeClass('fa-spin');
                }, 1000);
            });

            // Initialize
            loadTicketTypes();
        });
    </script>
}