@model int
@{
    Layout = "/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Manage Access Points";
}

<style>
    .access-point-icon {
        background-color: rgba(255, 193, 7, 0.1);
        border-radius: 8px;
        padding: 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }

    .form-check-input:checked {
        background-color: #ffc107;
        border-color: #ffc107;
    }

    .ticket-type-badge {
        background-color: #e9ecef;
        color: #495057;
        font-size: 0.85em;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
    }
</style>

<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center gap-3 mb-2">
                <a href="/TicketAccessPoint" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-arrow-left me-2"></i>Back to List
                </a>
                <div>
                    <h1 class="h3 mb-0 fw-bold">
                        <i class="fas fa-door-open text-warning me-2"></i>
                        Manage Access Points
                    </h1>
                    <p class="text-muted mb-0">
                        Assigning access points for:
                        <span id="ticketTypeName" class="fw-bold">Loading...</span>
                        <span id="ticketTypeDetails" class="ms-2 text-muted small"></span>
                    </p>
                </div>
            </div>

            <!-- Ticket Type Info Card -->
            <div class="card border-0 shadow-sm mb-4" id="ticketTypeInfoCard" style="display: none;">
                <div class="card-body p-3">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="card-title mb-1">
                                <i class="fas fa-ticket-alt text-warning me-2"></i>
                                <span id="ticketTypeFullName"></span>
                            </h6>
                            <p class="card-text text-muted small mb-0">
                                <span id="ticketTypeDescription"></span>
                            </p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <div class="d-flex flex-column flex-md-row gap-2 justify-content-md-end">
                                <span class="badge bg-warning text-dark" id="ticketTypeStatus"></span>
                                <span class="badge bg-info text-dark" id="ticketTypePrice"></span>
                                <span class="badge bg-secondary" id="ticketTypeCapacity"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-warning" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted mt-2">Loading ticket type and access points...</p>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageContainer" style="display: none;"></div>

    <!-- Form -->
    <form id="assignmentForm" method="post" action="/TicketAccessPoint/Save" style="display: none;">
        <input type="hidden" name="TicketTypeId" value="@Model" />

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pb-0">
                <h5 class="mb-3">
                    <i class="fas fa-list-check text-warning me-2"></i>
                    Select Access Points
                    <small class="text-muted ms-2">Choose which access points this ticket type can use</small>
                </h5>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <span class="text-muted small">
                            <i class="fas fa-info-circle me-1"></i>
                            <span id="selectedCount">0</span> of <span id="totalCount">0</span> access points selected
                        </span>
                    </div>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="selectAllBtn">
                            <i class="fas fa-check-double me-1"></i>Select All
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="clearAllBtn">
                            <i class="fas fa-times me-1"></i>Clear All
                        </button>
                    </div>
                </div>
            </div>

            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th width="5%">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAll">
                                        <label class="form-check-label" for="selectAll"></label>
                                    </div>
                                </th>
                                <th width="35%">Access Point</th>
                                <th width="45%">Description</th>
                                <th width="15%">Status</th>
                            </tr>
                        </thead>
                        <tbody id="accessPointsBody">
                            <!-- Data loaded here via API -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-4 pt-3 border-top">
                    <button type="submit" class="btn btn-warning px-4">
                        <i class="fas fa-save me-2"></i>Save Assignments
                    </button>
                    <a href="/TicketAccessPoint" class="btn btn-outline-secondary ms-2">
                        Cancel
                    </a>
                </div>
            </div>
        </div>
    </form>

    <!-- Empty State -->
    <div id="emptyState" class="text-center py-5" style="display: none;">
        <i class="fas fa-door-closed fa-4x text-muted mb-3"></i>
        <h5 class="text-muted">No Access Points Found</h5>
        <p class="text-muted">There are no access points available for this event.</p>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            const ticketTypeId = @Model;

            // Load ticket type details first, then access points
            loadTicketTypeDetails();
            loadAccessPoints();

            function loadTicketTypeDetails() {
                $.ajax({
                    url: '/TicketAccessPoint/GetTicketTypeDetails?ticketTypeId=' + ticketTypeId,
                    type: 'GET',
                    success: function(response) {
                        if (response) {
                            displayTicketTypeInfo(response);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading ticket type:', error);
                    }
                });
            }

            function displayTicketTypeInfo(ticketType) {
                $('#ticketTypeName').text(ticketType.name);
                $('#ticketTypeFullName').text(ticketType.name);
                $('#ticketTypeDescription').text(ticketType.description || 'No description');
                $('#ticketTypeStatus').text(ticketType.active ? 'Active' : 'Inactive');
                $('#ticketTypeStatus').removeClass('bg-warning bg-danger').addClass(ticketType.active ? 'bg-warning' : 'bg-danger');

                if (ticketType.price) {
                    $('#ticketTypePrice').text('$' + parseFloat(ticketType.price).toFixed(2));
                } else {
                    $('#ticketTypePrice').text('Free');
                }

                if (ticketType.capacity) {
                    $('#ticketTypeCapacity').text('Capacity: ' + ticketType.capacity);
                }

                $('#ticketTypeInfoCard').show();
            }

            function loadAccessPoints() {
                $.ajax({
                    url: '/TicketAccessPoint/LoadAccessPoints?ticketTypeId=' + ticketTypeId,
                    type: 'GET',
                    success: function(response) {
                        $('#loading').hide();

                        if (response && response.length > 0) {
                            renderAccessPoints(response);
                            $('#assignmentForm').show();
                            updateSelectionCount();
                        } else {
                            $('#emptyState').show();
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#loading').hide();
                        showAlert('danger', 'Error loading access points. Please try again.');
                        console.error('Error:', error);
                    }
                });
            }

            function renderAccessPoints(accessPoints) {
                let html = '';

                accessPoints.forEach(function(ap) {
                    html += `
                        <tr>
                            <td>
                                <div class="form-check">
                                    <input class="form-check-input access-point-checkbox"
                                           type="checkbox"
                                           name="AccessPointIds"
                                           value="${ap.accessPointId}"
                                           ${ap.isAssigned ? 'checked' : ''}
                                           data-name="${ap.name}">
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="access-point-icon me-3">
                                        <i class="fas ${getAccessPointIcon(ap.name)} text-warning"></i>
                                    </div>
                                    <div>
                                        <div class="fw-medium">${ap.name}</div>
                                        <small class="text-muted">ID: ${ap.accessPointId}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="small">${ap.description || 'No description'}</div>
                                ${ap.isAssigned ? '<span class="badge bg-warning text-dark small mt-1">Currently Assigned</span>' : ''}
                            </td>
                            <td>
                                <span class="badge ${ap.active ? 'bg-success' : 'bg-secondary'}">
                                    <i class="fas ${ap.active ? 'fa-check' : 'fa-times'} me-1"></i>
                                    ${ap.active ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                        </tr>
                    `;
                });

                $('#accessPointsBody').html(html);
                $('#totalCount').text(accessPoints.length);
                setupCheckboxEvents();
            }

            function getAccessPointIcon(name) {
                const nameLower = name.toLowerCase();
                if (nameLower.includes('gate')) return 'fa-gate';
                if (nameLower.includes('door')) return 'fa-door-closed';
                if (nameLower.includes('entrance')) return 'fa-sign-in-alt';
                if (nameLower.includes('exit')) return 'fa-sign-out-alt';
                if (nameLower.includes('vip')) return 'fa-crown';
                if (nameLower.includes('main')) return 'fa-building';
                if (nameLower.includes('back')) return 'fa-door-open';
                return 'fa-door-closed';
            }

            function setupCheckboxEvents() {
                // Select All functionality
                $('#selectAll').on('change', function() {
                    const isChecked = $(this).is(':checked');
                    $('.access-point-checkbox').prop('checked', isChecked);
                    updateSelectionCount();
                    $('#selectAllBtn').toggleClass('btn-secondary', isChecked);
                    $('#clearAllBtn').toggleClass('btn-secondary', !isChecked);
                });

                // Individual checkbox events
                $('.access-point-checkbox').on('change', function() {
                    updateSelectAllCheckbox();
                    updateSelectionCount();
                });

                // Select All button
                $('#selectAllBtn').on('click', function() {
                    $('.access-point-checkbox').prop('checked', true);
                    $('#selectAll').prop('checked', true);
                    updateSelectionCount();
                    $(this).addClass('btn-secondary');
                    $('#clearAllBtn').removeClass('btn-secondary');
                });

                // Clear All button
                $('#clearAllBtn').on('click', function() {
                    $('.access-point-checkbox').prop('checked', false);
                    $('#selectAll').prop('checked', false);
                    updateSelectionCount();
                    $(this).addClass('btn-secondary');
                    $('#selectAllBtn').removeClass('btn-secondary');
                });
            }

            function updateSelectAllCheckbox() {
                const allCheckboxes = $('.access-point-checkbox');
                const checkedCount = $('.access-point-checkbox:checked').length;
                $('#selectAll').prop('checked', allCheckboxes.length === checkedCount);
            }

            function updateSelectionCount() {
                const selectedCount = $('.access-point-checkbox:checked').length;
                const totalCount = $('.access-point-checkbox').length;
                $('#selectedCount').text(selectedCount);

                // Update button text
                const saveBtn = $('#assignmentForm button[type="submit"]');
                if (selectedCount === 0) {
                    saveBtn.html('<i class="fas fa-save me-2"></i>Save (Remove All)');
                } else {
                    saveBtn.html(`<i class="fas fa-save me-2"></i>Save (${selectedCount} Selected)`);
                }
            }

            // Form submission with proper feedback
            $('#assignmentForm').on('submit', function(e) {
                e.preventDefault();

                const form = $(this);
                const submitBtn = form.find('button[type="submit"]');
                const originalText = submitBtn.html();

                // Get selected checkboxes count
                const selectedCount = $('.access-point-checkbox:checked').length;

                // Optional: Show confirmation for no selection
                if (selectedCount === 0 && !confirm('No access points selected. This will remove all assignments from this ticket type. Continue?')) {
                    return;
                }

                // Disable button and show loading
                submitBtn.prop('disabled', true);
                submitBtn.html('<span class="spinner-border spinner-border-sm me-2"></span>Saving...');

                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: form.serialize(),
                    success: function(response) {
                        if (selectedCount === 0) {
                            showAlert('warning',
                                '<strong>All access points unassigned</strong><br>' +
                                'This ticket type no longer has access to any entry points.');
                        } else {
                            const selectedNames = [];
                            $('.access-point-checkbox:checked').each(function() {
                                selectedNames.push($(this).data('name'));
                            });

                            showAlert('success',
                                `<strong>${selectedCount} access point(s) assigned</strong><br>` +
                                `Ticket type can now use: ${selectedNames.join(', ')}`);
                        }

                        // Reload to reflect changes
                        loadAccessPoints();
                    },
                    error: function(xhr, status, error) {
                        let errorMessage = 'Error saving assignments';

                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage += ': ' + xhr.responseJSON.message;
                        } else if (xhr.status === 404) {
                            errorMessage = 'Ticket type not found.';
                        } else if (xhr.status === 400) {
                            errorMessage = 'Invalid request data.';
                        } else if (xhr.status === 500) {
                            errorMessage = 'Server error occurred. Please try again later.';
                        }

                        showAlert('danger', errorMessage);
                        console.error('Save error:', error, xhr.responseText);
                    },
                    complete: function() {
                        // Re-enable button after 1 second delay
                        setTimeout(() => {
                            submitBtn.prop('disabled', false);
                            updateSelectionCount(); // Update button text
                        }, 1000);
                    }
                });
            });

            // Enhanced alert function
            function showAlert(type, message) {
                const alertTypes = {
                    'success': {
                        icon: 'fa-check-circle',
                        title: 'Success!',
                        class: 'alert-success'
                    },
                    'danger': {
                        icon: 'fa-exclamation-circle',
                        title: 'Error!',
                        class: 'alert-danger'
                    },
                    'warning': {
                        icon: 'fa-exclamation-triangle',
                        title: 'Warning!',
                        class: 'alert-warning'
                    },
                    'info': {
                        icon: 'fa-info-circle',
                        title: 'Info',
                        class: 'alert-info'
                    }
                };

                const alertConfig = alertTypes[type] || alertTypes.info;

                const html = `
                    <div class="alert ${alertConfig.class} alert-dismissible fade show" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="fas ${alertConfig.icon} fa-lg me-3"></i>
                            <div>
                                ${message}
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;

                // Remove existing alerts
                $('.alert').alert('close');

                // Add new alert
                $('#messageContainer').html(html).show();

                // Auto-hide success messages after 5 seconds, keep errors/warnings longer
                const hideDelay = type === 'success' ? 5000 : 8000;

                if (type === 'success' || type === 'info') {
                    setTimeout(() => {
                        $('.alert').alert('close');
                    }, hideDelay);
                }
            }

            // Keyboard shortcut for select all (Ctrl+A)
            $(document).on('keydown', function(e) {
                if (e.ctrlKey && e.key === 'a') {
                    e.preventDefault();
                    $('#selectAll').click();
                }
            });
        });
    </script>
}