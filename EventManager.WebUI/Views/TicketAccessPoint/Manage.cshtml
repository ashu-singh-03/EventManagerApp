@model int
@{
    Layout = "/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Manage Access Points";
}

<div class="container-fluid py-4">
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-3">
            <div class="d-flex align-items-center">
                <a href="/TicketAccessPoint/Index"
                   class="btn btn-outline-warning d-flex align-items-center me-3">
                    <i class="fas fa-arrow-left me-2"></i>
                    Back
                </a>
                <div class="vr me-3"></div>
                <div>
                    <h5 class="mb-0 text-dark">
                        <i class="fas fa-door-open text-warning me-2"></i>
                        Access Points Management
                    </h5>
                    <small class="text-muted">Manage access points assignments for this ticket type</small>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100 bg-white">
                <div class="card-body p-3 d-flex align-items-center">
                    <div class="text-center me-3">
                        <i class="fas fa-cubes fa-2x text-warning"></i>
                    </div>
                    <div>
                        <p class="text-muted small fw-bold mb-0">Total Access Points</p>
                        <h4 class="fw-bold text-dark mb-0" id="totalCount">0</h4>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100 bg-white">
                <div class="card-body p-3 d-flex align-items-center">
                    <div class="text-center me-3">
                        <i class="fas fa-check-circle fa-2x text-success"></i>
                    </div>
                    <div>
                        <p class="text-muted small fw-bold mb-0">Assigned Access Points</p>
                        <h4 class="fw-bold text-success mb-0" id="assignedCount">0</h4>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100 bg-white">
                <div class="card-body p-3 d-flex align-items-center">
                    <div class="text-center me-3">
                        <i class="fas fa-minus-circle fa-2x text-secondary"></i>
                    </div>
                    <div>
                        <p class="text-muted small fw-bold mb-0">Unassigned Access Points</p>
                        <h4 class="fw-bold text-secondary mb-0" id="unassignedCount">0</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card border-0 shadow-lg">
        <div class="card-header bg-white border-bottom py-3">
            <div class="row align-items-center">
                <div class="col-lg-6 mb-2 mb-lg-0">
                    <h5 class="mb-0 text-dark">
                        <i class="fas fa-list-check text-warning me-2"></i>
                        Access Points List
                    </h5>
                </div>
                <div class="col-lg-6">
                    <div class="d-flex flex-wrap justify-content-lg-end gap-2">
                        <button type="button" class="btn btn-outline-warning btn-sm" id="selectAllBtn">
                            <i class="fas fa-check-double me-1"></i>Select All Visible
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="clearAllBtn">
                            <i class="fas fa-times me-1"></i>Clear All Visible
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-body p-0">
            <div id="messageContainer" class="m-3" style="display: none;"></div>

            <div id="loading" class="text-center py-5">
                <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted mt-2">Loading access points...</p>
            </div>

            <form id="assignmentForm" method="post" action="/TicketAccessPoint/Save" style="display: none;">
                <input type="hidden" name="TicketTypeId" value="@Model" />

                <div class="table-responsive p-3">
                    <table class="table table-hover table-striped mb-0" id="accessPointsTable" style="width:100%">
                        <thead class="table-light">
                            <tr>
                                <th width="5%" class="text-center">
                                </th>
                                <th width="35%">Access Point</th>
                                <th width="45%">Description</th>
                                <th width="15%">Status</th>
                            </tr>
                        </thead>
                        <tbody id="accessPointsBody">
                        </tbody>
                    </table>
                </div>

                <div id="emptyState" class="text-center py-5" style="display: none;">
                    <i class="fas fa-door-closed fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">No Access Points Found</h5>
                    <p class="text-muted">There are no access points available for this event.</p>
                </div>

                <div class="p-3 border-top bg-white sticky-bottom shadow-sm">
                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-warning px-4">
                            <i class="fas fa-save me-2"></i>Save Changes
                        </button>
                        <a href="/TicketAccessPoint" class="btn btn-outline-secondary ms-2">
                            Cancel
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            const ticketTypeId = @Model;
            let allAccessPoints = [];
            let dataTableInstance;

            // --- Utility Functions ---
            function getAccessPointIcon(name) {
                const nameLower = name.toLowerCase();
                if (nameLower.includes('gate')) return 'fa-gate-open';
                if (nameLower.includes('door')) return 'fa-door-closed';
                if (nameLower.includes('entrance')) return 'fa-sign-in-alt';
                if (nameLower.includes('exit')) return 'fa-sign-out-alt';
                if (nameLower.includes('vip')) return 'fa-star';
                return 'fa-door-closed';
            }

            // --- 🎯 MODIFIED SHOW ALERT FUNCTION (Enhanced Styling & Icons) 🎯 ---
            function showAlert(type, message) {
                let alertClass, iconClass, title;

                if (type === 'success') {
                    // Uses warning background for theme consistency, but green checkmark and border for success
                    alertClass = 'alert-warning border-start border-4 border-success';
                    iconClass = 'fas fa-check-circle text-success me-2';
                    title = 'Success!';
                } else if (type === 'warning') {
                    alertClass = 'alert-warning border-start border-4 border-warning';
                    iconClass = 'fas fa-exclamation-triangle text-warning me-2';
                    title = 'Attention:';
                } else if (type === 'danger') {
                    alertClass = 'alert-danger border-start border-4 border-danger';
                    iconClass = 'fas fa-times-circle text-danger me-2';
                    title = 'Error:';
                } else {
                    alertClass = 'alert-info border-start border-4 border-info';
                    iconClass = 'fas fa-info-circle text-info me-2';
                    title = 'Info:';
                }

                const html = `
                    <div class="alert ${alertClass} alert-dismissible fade show d-flex align-items-center" role="alert">
                        <i class="${iconClass} fs-5"></i>
                        <div>
                            <strong class="me-1">${title}</strong> ${message}
                        </div>
                        <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
                    </div>
                `;

                $('#messageContainer').html(html).show();
                // Auto-close success/info alerts
                if (type === 'success' || type === 'info') {
                    setTimeout(() => { $('.alert').alert('close'); }, 5000);
                }
            }
            // --- END SHOW ALERT ---


            function updateStats() {
                const total = allAccessPoints.length;
                const assigned = allAccessPoints.filter(ap => ap.isChecked).length;
                const unassigned = total - assigned;

                $('#totalCount').text(total);
                $('#assignedCount').text(assigned);
                $('#unassignedCount').text(unassigned);
            }

            function initializeDataTables(data) {
                if (dataTableInstance) {
                    dataTableInstance.destroy();
                    $('#accessPointsBody').empty();
                }

                const tableData = data.map(ap => [
                    ap.accessPointId,
                    ap.name,
                    ap.description,
                    ap.isChecked
                ]);

                dataTableInstance = $('#accessPointsTable').DataTable({
                    data: tableData,
                    columns: [
                        {
                            data: 0, // Checkbox column
                            render: function(data, type, row) {
                                const isChecked = row[3];
                                return `
                                    <div class="form-check text-center">
                                        <input class="form-check-input access-point-checkbox"
                                            type="checkbox"
                                            value="${data}"
                                            ${isChecked ? 'checked' : ''}
                                            data-name="${row[1]}"
                                            style="margin: 0 auto;">
                                    </div>
                                `;
                            },
                            orderable: false,
                            className: 'ps-3'
                        },
                        {
                            data: 1, // Name column
                            render: function(data, type, row) {
                                const icon = getAccessPointIcon(data);
                                return `
                                    <div class="d-flex align-items-center">
                                        <i class="fas ${icon} fa-fw fs-5 text-warning me-3"></i>
                                        <div class="fw-medium">${data}</div>
                                    </div>
                                `;
                            }
                        },
                        {
                            data: 2, // Description column
                            className: 'small text-muted text-truncate',
                            render: function(data) {
                                return data || 'No description';
                            }
                        },
                        {
                            data: 3, // Status column
                            render: function(data) {
                                const statusText = data ? 'Assigned' : 'Unassigned';
                                const statusClass = data ? 'bg-success' : 'bg-secondary';
                                return `<span class="badge ${statusClass}">${statusText}</span>`;
                            }
                        }
                    ],
                    lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
                    pageLength: 25,
                    dom: 'lfrtip',
                    responsive: true
                });

                // Event delegation for checkbox changes
                $('#accessPointsBody').off('change', '.access-point-checkbox').on('change', '.access-point-checkbox', function() {
                    updateGlobalState($(this).val(), $(this).is(':checked'));
                    updateStats();
                });
            }

            function updateGlobalState(id, isChecked) {
                const ap = allAccessPoints.find(item => item.accessPointId.toString() === id.toString());
                if (ap) {
                    ap.isChecked = isChecked;
                }

                if (dataTableInstance) {
                    dataTableInstance.rows().every(function() {
                        const rowData = this.data();
                        if (rowData[0].toString() === id.toString()) {
                            rowData[3] = isChecked;
                            this.data(rowData);
                            this.invalidate();
                        }
                    });
                    dataTableInstance.draw(false);
                }
            }

            function loadAccessPoints() {
                $('#loading').show();
                $('#assignmentForm').hide();
                $('#emptyState').hide();

                $.ajax({
                    url: '/TicketAccessPoint/LoadAccessPoints?ticketTypeId=' + ticketTypeId,
                    type: 'GET',
                    success: function(response) {
                        $('#loading').hide();
                        allAccessPoints = response || [];

                        if (allAccessPoints.length > 0) {
                            allAccessPoints.forEach(ap => ap.isChecked = ap.isAssigned);
                            initializeDataTables(allAccessPoints);
                            $('#assignmentForm').show();
                        } else {
                            $('#emptyState').show();
                        }
                        updateStats();
                    },
                    error: function(xhr, status, error) {
                        $('#loading').hide();
                        showAlert('danger', 'Error loading access points. Please try again.');
                        console.error('Error:', error);
                    }
                });
            }

            // --- Event Handlers ---
            loadAccessPoints();

            // Select All Visible
            $('#selectAllBtn').on('click', function() {
                if (dataTableInstance) {
                    dataTableInstance.rows({ search: 'applied', page: 'current' }).nodes().to$().find('.access-point-checkbox').each(function() {
                        const id = $(this).val();
                        $(this).prop('checked', true);
                        updateGlobalState(id, true);
                    });
                    updateStats();
                }
            });

            // Clear All Visible
            $('#clearAllBtn').on('click', function() {
                if (dataTableInstance) {
                    dataTableInstance.rows({ search: 'applied', page: 'current' }).nodes().to$().find('.access-point-checkbox').each(function() {
                        const id = $(this).val();
                        $(this).prop('checked', false);
                        updateGlobalState(id, false);
                    });
                    updateStats();
                }
            });

            // Form Submission
            $('#assignmentForm').on('submit', function(e) {
                e.preventDefault();

                const form = $(this);
                const submitBtn = form.find('button[type="submit"]');

                const checkedPoints = allAccessPoints.filter(ap => ap.isChecked);
                const selectedCount = checkedPoints.length;
                const checkedIds = checkedPoints.map(ap => ap.accessPointId);

                // Confirmation for clearing all
                if (selectedCount === 0 && !confirm('No access points selected. This will remove all assignments. Continue?')) {
                    return;
                }

                const postData = {
                    TicketTypeId: ticketTypeId,
                    AccessPointIds: checkedIds
                };

                submitBtn.prop('disabled', true);
                submitBtn.html('<span class="spinner-border spinner-border-sm me-2"></span>Saving...');

                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: postData,
                    success: function(response) {
                        if (response && response.success) {
                            let alertMessage;

                            if (selectedCount === 0) {
                                alertMessage = 'Successfully cleared all access assignments.';
                                showAlert('warning', alertMessage);
                            } else {
                                alertMessage = `Successfully saved ${selectedCount} access point(s) assigned to this ticket type.`;
                                showAlert('success', alertMessage);
                            }
                            loadAccessPoints();
                        } else {
                             showAlert('danger', 'Save failed: Server returned an error.');
                        }
                    },
                    error: function(xhr, status, error) {
                        let errorMessage = 'Error saving assignments. Please try again.';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = 'Error saving assignments: ' + xhr.responseJSON.message;
                        }
                        showAlert('danger', errorMessage);
                    },
                    complete: function() {
                        setTimeout(() => {
                            submitBtn.prop('disabled', false);
                            submitBtn.html('<i class="fas fa-save me-2"></i>Save Changes');
                        }, 1000);
                    }
                });
            });
        });
    </script>
}